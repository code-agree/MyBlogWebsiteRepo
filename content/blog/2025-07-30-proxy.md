+++
title = '代理服务器配置最佳实践'
date = 2025-07-30T17:09:27+08:00
draft = true
+++

## 项目背景

**需求**：US服务器 (172.x.x.x) 通过 HK服务器 (192.x.x.x) 代理访问 OKX WebSocket服务

**网络环境**：专线连接的私有网络，HK服务器有公网IP (47.x.x.x)

## 代理原理简介

### HTTP代理工作原理

```
US服务器 → HK代理服务器 → 目标服务器(OKX)
   ↑              ↑              ↑
客户端         代理服务器        Web服务器
```

### WebSocket代理机制

1. **CONNECT隧道建立**：
   ```
   US → HK: CONNECT ws.okx.com:443 HTTP/1.1
   HK → US: HTTP/1.1 200 Connection established
   ```

2. **透明数据转发**：
   ```
   US ←→ HK ←→ OKX
   [SSL握手和WebSocket数据直接在US和OKX之间传输]
   ```

3. **squid的作用**：
   - 建立TCP隧道
   - 透明转发所有数据包
   - 不解密SSL内容
   - 提供访问控制

## 完整配置流程

### 第一步：HK服务器环境准备

```bash
# 1. 更新系统
yum update -y

# 2. 安装squid
yum install -y squid

# 3. 备份默认配置
cp /etc/squid/squid.conf /etc/squid/squid.conf.original
```

### 第二步：配置squid代理服务

```bash
# 创建squid配置文件
cat > /etc/squid/squid.conf << 'EOF'
# 监听端口（使用已开放的安全组端口）
http_port 18000

# 允许US服务器访问
acl us_server src 172.x.x.x/32
http_access allow us_server

# 允许HTTPS CONNECT方法
acl SSL_ports port 443
acl SSL_ports port 8443
acl CONNECT method CONNECT
http_access allow CONNECT SSL_ports

# 拒绝其他访问
http_access deny all

# 日志配置
access_log /var/log/squid/access.log
cache_log /var/log/squid/cache.log

# 缓存配置（禁用缓存，适用于实时数据）
cache deny all
EOF
```

### 第三步：启动和验证服务

```bash
# 1. 检查配置语法
squid -k parse

# 2. 启用开机自启
systemctl enable squid

# 3. 启动服务
systemctl start squid

# 4. 检查服务状态
systemctl status squid

# 5. 验证端口监听
ss -tlnp | grep :18000
```

### 第四步：本地功能测试

```bash
# 在HK服务器上测试代理功能
curl -x http://127.0.0.1:18000 http://httpbin.org/ip -v
curl -x http://127.0.0.1:18000 https://httpbin.org/ip -v

# 测试目标服务直连
wscat -c wss://colows-d.okx.com/ws/v5/public -x '{"id": "1512", "op": "subscribe", "args": [{"channel": "trades", "instId": "BTC-USDT"}]}'
```

### 第五步：网络连通性验证

```bash
# 在US服务器上测试连通性
nc -zv 192.x.x.x 18000

# 测试HTTP代理
curl -x http://192.x.x.x:18000 http://httpbin.org/ip -v

# 测试HTTPS代理
curl -x http://192.x.x.x:18000 https://httpbin.org/ip -v
```

### 第六步：WebSocket代理测试  

```bash
# 在US服务器上安装wscat
npm install -g wscat

# 方法1：环境变量设置
export https_proxy=http://192.x.x.x:18000
wscat -c wss://colows-d.okx.com/ws/v5/public -x '{"id": "1512", "op": "subscribe", "args": [{"channel": "trades", "instId": "BTC-USDT"}]}'

# 方法2：直接指定代理
wscat -c wss://colows-d.okx.com/ws/v5/public \
  --proxy http://192.x.x.x:18000 \
  -x '{"id": "1512", "op": "subscribe", "args": [{"channel": "trades", "instId": "BTC-USDT"}]}'
```

## 核心配置要点

### 1. 端口选择策略
- ✅ **使用已开放的安全组端口**（如18000）
- ❌ 避免重新申请安全组规则

### 2. 访问控制配置
```bash
# 精确的源IP控制
acl us_server src 172.x.x.x/32  # 单IP精确控制
# acl us_network src 172.18.0.0/16  # 网段控制（可选）

# 端口控制
acl SSL_ports port 443    # 标准HTTPS端口
acl SSL_ports port 8443   # 常用WebSocket SSL端口
```

### 3. 安全最佳实践
```bash
# 最小权限原则
http_access allow us_server          # 仅允许指定服务器
http_access allow CONNECT SSL_ports  # 仅允许SSL端口
http_access deny all                 # 拒绝其他所有访问

# 禁用缓存（适用于实时数据）
cache deny all
```

## 故障排查方法

### 1. 服务状态检查
```bash
# 检查squid服务
systemctl status squid
ps aux | grep squid

# 检查端口监听
ss -tlnp | grep :18000
netstat -tlnp | grep :18000
```

### 2. 网络连通性测试
```bash
# 基础连通性
ping 192.x.x.x
nc -zv 192.x.x.x 18000

# 路由检查  
ip route get 192.x.x.x
```

### 3. 日志分析
```bash
# 实时监控访问日志
tail -f /var/log/squid/access.log

# 检查错误日志
tail -f /var/log/squid/cache.log

# 系统日志
journalctl -u squid -f
```

### 4. 配置验证
```bash
# 语法检查
squid -k parse

# 配置检查
squid -k check
```

## 常见问题解决

### 问题1：连接超时
**原因**：防火墙或安全组阻止
**解决**：
- 检查系统防火墙：`systemctl status firewalld`
- 检查云服务器安全组配置
- 使用已开放端口

### 问题2：DNS解析失败
**原因**：域名解析问题
**解决**：
```bash
# 检查DNS配置
cat /etc/resolv.conf
nslookup ws.okx.com
```

### 问题3：SSL证书错误
**原因**：不当使用stunnel
**解决**：
- 移除stunnel配置
- 使用squid透明代理即可

## 性能优化建议

### 1. 系统级优化
```bash
# 调整文件描述符限制
echo "squid soft nofile 65536" >> /etc/security/limits.conf
echo "squid hard nofile 65536" >> /etc/security/limits.conf
```

### 2. squid配置优化
```bash
# 添加到squid.conf（可选）
max_filedescriptors 65536
workers 2  # 根据CPU核心数调整
```

### 3. 监控和日志轮转
```bash
# 配置日志轮转
cat > /etc/logrotate.d/squid << 'EOF'
/var/log/squid/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    create 644 squid squid
    postrotate
        /usr/bin/systemctl reload squid
    endscript
}  
EOF
```

## 总结

### 架构优势
- ✅ **简单高效**：仅使用squid，无需stunnel
- ✅ **透明代理**：端到端SSL加密保持
- ✅ **精确控制**：IP和端口级别的访问控制
- ✅ **易于维护**：配置文件简洁明了

### 核心原则
1. **最小权限**：仅允许必要的访问
2. **透明转发**：不破坏原有的SSL加密
3. **使用现有资源**：利用已开放的安全组端口
4. **简化架构**：避免不必要的组件

### 适用场景
- 跨地域网络访问加速
- 绕过地域限制
- 网络流量统一出口
- 访问控制和审计

这套配置方案经过实际验证，适用于生产环境的WebSocket代理需求。